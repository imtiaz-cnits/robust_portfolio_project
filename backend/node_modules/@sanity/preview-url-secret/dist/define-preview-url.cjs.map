{"version":3,"file":"define-preview-url.cjs","sources":["../src/definePreviewUrl.ts"],"sourcesContent":["import {\n  urlSearchParamPreviewPathname,\n  urlSearchParamPreviewSecret,\n} from './constants'\nimport type {\n  PreviewUrlResolver,\n  PreviewUrlResolverContext,\n  PreviewUrlResolverOptions,\n} from './types'\n\n/**\n * @internal\n */\nexport function definePreviewUrl<SanityClientType>(\n  options: PreviewUrlResolverOptions,\n): PreviewUrlResolver<SanityClientType> {\n  const {\n    draftMode,\n    previewMode,\n    origin = typeof location === 'undefined'\n      ? 'https://localhost'\n      : location.origin,\n  } = options\n  const enableUrl = previewMode?.enable || draftMode?.enable\n  let { preview = '/' } = options\n  const productionUrl = new URL(preview, origin)\n  const enablePreviewModeUrl = enableUrl\n    ? new URL(enableUrl, origin)\n    : undefined\n\n  return async (context): Promise<string> => {\n    try {\n      if (context.previewSearchParam) {\n        const restoredUrl = new URL(context.previewSearchParam, productionUrl)\n        if (restoredUrl.origin === productionUrl.origin) {\n          preview = `${restoredUrl.pathname}${restoredUrl.search}`\n        }\n      } else if (context.referrer) {\n        const referrerUrl = new URL(context.referrer)\n        if (referrerUrl.origin === productionUrl.origin) {\n          preview = `${referrerUrl.pathname}${referrerUrl.search}`\n        }\n      }\n    } catch {\n      // ignore\n    }\n    // Prevent infinite recursion\n    if (\n      typeof location !== 'undefined' &&\n      location.origin === productionUrl.origin &&\n      context.studioBasePath &&\n      (preview.startsWith(`${context.studioBasePath}/`) ||\n        preview === context.studioBasePath)\n    ) {\n      preview = options.preview || '/'\n    }\n    const previewUrl = new URL(preview, productionUrl)\n    if (enablePreviewModeUrl) {\n      const enablePreviewModeRequestUrl = new URL(enablePreviewModeUrl)\n      const { searchParams } = enablePreviewModeRequestUrl\n      searchParams.set(urlSearchParamPreviewSecret, context.previewUrlSecret)\n      if (previewUrl.pathname !== enablePreviewModeRequestUrl.pathname) {\n        searchParams.set(\n          urlSearchParamPreviewPathname,\n          `${previewUrl.pathname}${previewUrl.search}`,\n        )\n      }\n\n      return enablePreviewModeRequestUrl.toString()\n    }\n    return previewUrl.toString()\n  }\n}\n\nexport type {\n  PreviewUrlResolver,\n  PreviewUrlResolverContext,\n  PreviewUrlResolverOptions,\n}\n"],"names":["exports","definePreviewUrl","options","draftMode","previewMode","origin","location","enableUrl","enable","preview","productionUrl","URL","enablePreviewModeUrl","async","context","previewSearchParam","restoredUrl","concat","pathname","search","referrer","referrerUrl","studioBasePath","startsWith","previewUrl","enablePreviewModeRequestUrl","searchParams","set","urlSearchParamPreviewSecret","previewUrlSecret","urlSearchParamPreviewPathname","b","toString"],"mappings":"sHAwEAA,QAAAC,iBA3DO,SACLC,GAEM,MAAAC,UACJA,EAAAC,YACAA,EAAAC,OACAA,GAA6B,oBAAbC,SACZ,oBACAA,SAASD,SACXH,EACEK,GAAyB,MAAbH,OAAa,EAAAA,EAAAI,UAAqB,MAAXL,OAAW,EAAAA,EAAAK,QAChD,IAAAC,QAAEA,EAAU,KAAQP,EACxB,MAAMQ,EAAgB,IAAIC,IAAIF,EAASJ,GACjCO,EAAuBL,EACzB,IAAII,IAAIJ,EAAWF,QACnB,EAEJ,OAAOQ,MAAOC,IACR,IACF,GAAIA,EAAQC,mBAAoB,CAC9B,MAAMC,EAAc,IAAIL,IAAIG,EAAQC,mBAAoBL,GACpDM,EAAYX,SAAWK,EAAcL,SAC7BI,EAAA,GAAGQ,OAAYD,EAAAE,UAAWD,OAAYD,EAAAG,QAClD,MACF,GAAWL,EAAQM,SAAU,CAC3B,MAAMC,EAAc,IAAIV,IAAIG,EAAQM,UAChCC,EAAYhB,SAAWK,EAAcL,SAC7BI,EAAA,GAAGQ,OAAYI,EAAAH,UAAWD,OAAYI,EAAAF,QAEpD,CAAA,CACM,MAER,CAGsB,oBAAbb,UACPA,SAASD,SAAWK,EAAcL,QAClCS,EAAQQ,iBACPb,EAAQc,WAAW,GAAGN,OAAQH,EAAAQ,eAAc,OAC3Cb,IAAYK,EAAQQ,kBAEtBb,EAAUP,EAAQO,SAAW,KAE/B,MAAMe,EAAa,IAAIb,IAAIF,EAASC,GACpC,GAAIE,EAAsB,CAClB,MAAAa,EAA8B,IAAId,IAAIC,IACtCc,aAAEA,GAAiBD,EASzB,OARaC,EAAAC,IAAIC,EAAAA,EAA6Bd,EAAQe,kBAClDL,EAAWN,WAAaO,EAA4BP,UACzCQ,EAAAC,IACXG,EAAAC,EACA,GAAGd,OAAWO,EAAAN,UAAWD,OAAWO,EAAAL,SAIjCM,EAA4BO,UACrC,CACA,OAAOR,EAAWQ,UAAS,CAE/B"}